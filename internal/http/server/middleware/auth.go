package middleware

import (
	"github.com/cockroachdb/errors"
	"github.com/labstack/echo/v4"
	"github.com/neatplex/nightell-core/internal/services/container"
)

func Authorize(ctr *container.Container) func(echo.HandlerFunc) echo.HandlerFunc {
	return func(next echo.HandlerFunc) echo.HandlerFunc {
		return func(ctx echo.Context) error {
			authHeader := ctx.Request().Header.Get("Authorization")
			if len(authHeader) < len("Bearer X") {
				return echo.ErrUnauthorized
			}

			token, err := ctr.TokenService.FindByValue(authHeader[len("Bearer "):])
			if err != nil {
				return errors.WithStack(err)
			}
			if token == nil {
				return echo.ErrUnauthorized
			}

			ctx.Set("user", token.User)

			return next(ctx)
		}
	}
}
